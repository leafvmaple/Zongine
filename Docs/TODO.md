# TODO

## 🎨 材质系统改进路线图

### 阶段 1：基础架构 (2-3 周)

#### 1.1 统一材质参数系统

- [ ] 设计并实现带类型安全的 `MaterialParameter` 类
- [ ] 支持参数类型：Float, Float2, Float3, Float4, Color, Texture2D, Integer, Boolean
- [ ] 添加参数元数据（显示名称、分组、最小/最大值）
- [ ] 实现参数序列化/反序列化

#### 1.2 材质实例化

- [ ] 实现带参数管理的 `Material` 基类
- [ ] 添加父子材质继承系统
- [ ] 支持参数覆盖追踪
- [ ] 实现材质实例的创建和管理

#### 1.3 参数编辑器 UI 集成

- [ ] 创建 Qt 的 `MaterialEditorWidget`
- [ ] 根据材质参数自动生成 UI
- [ ] 实现参数值变化回调
- [ ] 添加纹理选择对话框集成
- [ ] 编辑器中的实时材质预览

---

### 阶段 2：PBR 渲染 (3-4 周)

#### 2.1 标准 PBR 材质

- [ ] 设计 `PBRMaterialParams` 结构
- [ ] 实现基础色、金属度、粗糙度属性
- [ ] 添加环境光遮蔽支持
- [ ] 支持自发光属性

#### 2.2 金属-粗糙度工作流

- [ ] 实现 PBR 纹理支持（反照率、法线、金属粗糙度、AO、自发光）
- [ ] 创建 PBR HLSL 着色器 (PBR.fx)
- [ ] 实现 Cook-Torrance BRDF
  - [ ] 分布函数 (GGX)
  - [ ] 几何函数 (Smith)
  - [ ] 菲涅尔函数 (Schlick)
- [ ] 支持不同的透明模式（不透明、遮罩、混合）

#### 2.3 基于图像的光照 (IBL)

- [ ] 实现环境贴图支持
- [ ] 添加漫反射辐照度贴图
- [ ] 添加带 BRDF 积分的镜面反射
- [ ] 支持 HDR 环境贴图
- [ ] 实现预过滤环境贴图

---

### 阶段 3：高级特性 (4-6 周)

#### 3.1 材质变体系统

- [ ] 设计 `MaterialVariant` 结构
- [ ] 实现特性标志系统
  - [ ] HAS_NORMAL_MAP（法线贴图）
  - [ ] HAS_METALLIC_MAP（金属度贴图）
  - [ ] HAS_AO_MAP（AO 贴图）
  - [ ] HAS_EMISSIVE（自发光）
  - [ ] USE_VERTEX_COLOR（顶点色）
  - [ ] USE_SKINNING（蒙皮）
  - [ ] ALPHA_BLEND / ALPHA_TEST（透明度）
  - [ ] TWO_SIDED（双面）
- [ ] 创建带缓存的 `MaterialVariantManager`
- [ ] 基于网格属性实现变体选择

#### 3.2 着色器排列自动化

- [ ] 设计 `ShaderPermutationGenerator`
- [ ] 实现带宏定义的自动着色器编译
- [ ] 创建排列哈希和缓存系统
- [ ] 添加着色器编译结果存储
- [ ] 优化排列生成（仅编译使用的变体）

#### 3.3 材质分层系统（可选）

- [ ] 设计 `MaterialLayer` 结构
- [ ] 实现混合模式（线性插值、相加、相乘、覆盖、高度混合）
- [ ] 添加层混合遮罩支持
- [ ] 支持每层 UV 变换
- [ ] 创建 `LayeredMaterial` 类
- [ ] 实现层合成着色器逻辑

---

### 阶段 4：工具链与管线 (2-3 周)

#### 4.1 材质库与预设

- [ ] 创建 `MaterialLibrary` 类
- [ ] 实现材质模板系统
- [ ] 添加预设材质：
  - [ ] 金属材质（多种粗糙度级别）
  - [ ] 塑料材质
  - [ ] 玻璃材质
  - [ ] 木材材质
  - [ ] 织物材质
- [ ] 编辑器中的材质浏览器 UI

#### 4.2 可视化材质编辑器（可选 - 高级）

- [ ] 设计材质节点系统架构
- [ ] 实现基础 `MaterialNode` 类
- [ ] 创建常用材质节点：
  - [ ] 常量节点
  - [ ] 参数节点
  - [ ] 纹理采样节点
  - [ ] 数学运算（加、乘、插值等）
  - [ ] 菲涅尔效果节点
  - [ ] 法线贴图节点
- [ ] 实现 `MaterialGraphCompiler`（节点图转 HLSL）
- [ ] 创建可视化节点编辑器 UI
- [ ] 添加节点连接验证

#### 4.3 材质热重载

- [ ] 实现材质文件的文件系统监视器
- [ ] 添加着色器热重载支持
- [ ] 实现材质参数热更新
- [ ] 添加纹理热重载
- [ ] 编辑器集成和通知

---

### 阶段 5：优化与完善 (1-2 周)

#### 5.1 性能优化

- [ ] 实现材质批处理
- [ ] 添加着色器变体预加载
- [ ] 优化参数更新（脏标记系统）
- [ ] 材质的 GPU 实例化支持
- [ ] 材质 LOD 系统

#### 5.2 文档编写

- [ ] 编写材质系统架构文档
- [ ] 创建 PBR 材质工作流指南
- [ ] 添加材质参数参考
- [ ] 创建材质制作教程
- [ ] 记录着色器排列系统

#### 5.3 测试与质量保证

- [ ] 为材质参数系统创建单元测试
- [ ] 添加材质变体选择测试
- [ ] 性能基准测试
- [ ] PBR 渲染的视觉回归测试
- [ ] 边界情况处理（缺失纹理、无效参数）

---

## 📋 历史遗留任务

- [ ] 闪点的材质Mtl_Std_ColorcastCharacter_SD_CHS_Modify.fx5

---

## 📝 备注

**依赖项：**

- DirectXTex 用于纹理加载 (✅ 已集成)
- Effects11 用于着色器效果 (✅ 已集成)
- Qt 6 用于编辑器 UI (✅ 已集成)

**预计总时间：** 12-18 周

**优先级顺序：**

1. 阶段 1（关键 - 基础架构）
2. 阶段 2（高 - 现代渲染）
3. 阶段 4.1 & 4.3（中 - 可用性）
4. 阶段 3（中 - 高级特性）
5. 阶段 4.2（低 - 锦上添花）
6. 阶段 5（持续 - 优化）

**参考资料：**

- [LearnOpenGL PBR](https://learnopengl.com/PBR/Theory)
- [Unreal Engine 材质系统](https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/)
- [Unity Shader Graph](https://unity.com/features/shader-graph)
- [glTF 2.0 规范](https://www.khronos.org/gltf/)
